# Документация P2P платежной системы

## Обзор

Система платежей реализует модель P2P платформы с использованием ЮKassa. Деньги списываются с карты клиента сразу, но находятся на удержании до подтверждения выполнения услуги.

## Процесс оплаты

### 1. Создание платежа

- **Endpoint**: `POST /api/v1/payments/`
- **Параметры**: `enroll_id`, `return_url` (опционально)
- **Логика**:
  - Платеж создается с `capture=False` (деньги на удержании)
  - Статус: `waiting_for_capture`
  - Возвращается `confirmation_url` для редиректа на оплату

### 2. Оплата клиентом

- Клиент переходит по `confirmation_url` и оплачивает
- Деньги списываются с карты, но остаются на удержании в ЮKassa
- Статус платежа: `waiting_for_capture`

### 3. Подтверждение готовности мастером

- Мастер подтверждает готовность работы
- Статус enroll: `confirmed` → `ready`

### 4. Подтверждение заказа клиентом

- **Endpoint**: `POST /api/v1/enrolls/{enroll_id}/confirm`
- **Логика**:
  - Статус enroll: `ready` → `completed`
  - Проверяется статус платежа в ЮKassa
  - Если `waiting_for_capture` → выполняется `capture`
  - Деньги переходят в магазин ЮKassa
  - Запускается оркестратор для распределения средств

## Распределение средств (Оркестратор)

После подтверждения клиентом запускается `trafic_orchestrator`:

1. **Выплата мастеру** (90% от суммы, минус 6% налог = 84.6% чистыми)

   - Используется счет мастера из таблицы `accounts`
   - Проверяется статус счета (`verified`)

2. **Комиссия платформы** (10% от суммы)
   - Выплачивается на карту из переменной окружения `DEVELOPER_CARD`

## Статусы платежей

- `pending` - Ожидание оплаты
- `processing` - Обработка (waiting_for_capture)
- `succeeded` - Оплачен (после capture)
- `canceled` - Отменен
- `failed` - Ошибка

## Статусы записей (enrolls)

- `pending` - Ожидает подтверждения мастера
- `confirmed` - Принято мастером
- `ready` - Готово к подтверждению клиентом (мастер подтвердил готовность)
- `completed` - Завершено (клиент подтвердил, средства распределены)
- `cancelled` - Отменено
- `expired` - Истекло

## API Endpoints

### Платежи

- `GET /api/v1/payments/` - Список платежей пользователя
- `POST /api/v1/payments/` - Создать платеж
- `GET /api/v1/payments/{payment_id}/status` - Статус платежа
- `POST /api/v1/payments/webhook` - Webhook от ЮKassa

### Записи

- `POST /api/v1/enrolls/{enroll_id}/complete` - Мастер подтверждает готовность
- `POST /api/v1/enrolls/{enroll_id}/confirm` - Клиент подтверждает заказ

## Безопасность

- Все платежи требуют авторизации (JWT)
- Webhook проверяется через `verify_webhook_signature`
- Rate limiting на всех endpoints
- `yookassa_payment_id` не возвращается в списке платежей

## Важные моменты

1. **Capture платежа**: Выполняется автоматически при подтверждении клиентом
2. **Оркестратор**: Запускается в фоне через `create_task`
3. **Счета мастеров**: Должны быть верифицированы (`status='verified'`) для выплат
4. **Комиссия**: 10% платформе, 90% мастеру (минус 6% налог)


### ДЕМО ВЕРСИЯ ВКЛЮЧЕНА
иммитирование процесса безопасной сделки со статусами (реальная бс реализована и ожидает подписания договра для будущего расширения сайта)